<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geli≈ümi≈ü ƒ∞nteraktif Ders Programƒ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            padding: 1rem;
        }
        .app-container {
            max-width: 1400px;
            margin: auto;
            background-color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 1rem;
        }
        .neon-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: #fff;
            text-shadow:
                0 0 5px #00aaff,
                0 0 10px #00aaff,
                0 0 20px #00aaff,
                0 0 40px #00aaff,
                0 0 80px #00aaff;
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #00aaff, 0 0 11px #00aaff, 0 0 19px #00aaff, 0 0 40px #00aaff, 0 0 80px #00aaff; }
            20%, 24%, 55% { text-shadow: none; }
        }
        .tab-button { background-color: #374151; transition: all 0.3s ease; }
        .tab-button.active { background-color: #2563EB; color: #FFFFFF; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #2c3e50; padding: 8px; text-align: center; min-width: 100px; height: 60px; position: relative; transition: background-color 0.3s; }
        th { background-color: #2c3e50; color: white; font-weight: bold; }
        th.day-header, th.time-header { border: 2px solid #10B981; }
        td:hover { background-color: #4a5568; cursor: pointer; }
        .current-lesson { background-color: #2f855a !important; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(47, 133, 90, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(47, 133, 90, 0); }
            100% { box-shadow: 0 0 0 0 rgba(47, 133, 90, 0); }
        }
        .note-indicator { position: absolute; bottom: 4px; left: 4px; font-size: 0.8rem; }
        .modal { background-color: rgba(0,0,0,0.7); }
        .notification { transition: opacity 0.5s, transform 0.5s; }
        .header-info-container { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-900">

    <div id="auth-container" class="max-w-md mx-auto mt-10">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold text-center text-white mb-6">Giri≈ü Yap veya Kayƒ±t Ol</h2>
            <div id="auth-error" class="bg-red-500 text-white p-3 rounded-lg mb-4 text-center hidden"></div>
            <div class="space-y-4">
                <div>
                    <label for="email" class="block mb-2 text-sm font-medium text-gray-300">E-posta</label>
                    <input type="email" id="email" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="ornek@eposta.com" required>
                </div>
                <div>
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">≈ûifre</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button id="login-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Giri≈ü Yap</button>
                    <button id="register-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Kayƒ±t Ol</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <div class="app-container">
            <div class="header-info-container text-center">
                <div>
                    <h1 id="user-name" class="text-3xl font-bold text-white"></h1>
                    <p id="user-branch" class="text-lg text-blue-300"></p>
                </div>
                <p class="text-md text-gray-400">Derslerinizi ve notlarƒ±nƒ±zƒ± kolayca y√∂netin.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-blue-300">Tarih ve Saat</p><p id="current-time" class="text-xl font-mono"></p></div>
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-green-300">≈ûu Anki Ders</p><p id="current-lesson-info" class="text-xl"></p><p id="current-lesson-note-preview" class="text-sm text-yellow-300 mt-1 truncate"></p></div>
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-purple-300">Sonraki Ders</p><p id="next-lesson-info" class="text-xl"></p></div>
            </div>
            <nav class="grid grid-cols-2 gap-2 mb-4">
                <button class="tab-button active text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('schedule')">Ders Programƒ±</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('calendar')">Akademik Takvim</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('holidays')">Resm√Æ Tatiller</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('settings')">Ayarlar</button>
            </nav>
            <div id="app-content">
                <div id="schedule-tab" class="tab-content"><div class="overflow-x-auto"><table class="min-w-full bg-slate-800 border-collapse"><thead><tr><th class="w-24 time-header">Saat</th><th class="day-header">Pazartesi</th><th class="day-header">Salƒ±</th><th class="day-header">√áar≈üamba</th><th class="day-header">Per≈üembe</th><th class="day-header">Cuma</th></tr></thead><tbody id="schedule-body"></tbody></table></div></div>
                <div id="calendar-tab" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4 text-center text-white">Akademik Takvim</h2><ul id="academic-calendar-list" class="space-y-3"></ul></div>
                <div id="holidays-tab" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4 text-center text-white">Resm√Æ Tatiller (2025-2026)</h2><ul id="public-holidays-list" class="space-y-3"></ul></div>
                <div id="settings-tab" class="tab-content hidden">
                     <div class="flex justify-end mb-4 -mt-4">
                        <button id="logout-button" class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">√áƒ±kƒ±≈ü Yap</button>
                     </div>
                    <h2 class="text-2xl font-bold mb-6 text-center text-white">Ayarlar</h2>
                    <div class="max-w-md mx-auto space-y-4">
                        <div><label for="name-input" class="block mb-2 text-sm font-medium text-gray-300">ƒ∞sim Soyisim</label><input type="text" id="name-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="√ñrn: Muhammed √ñmer Doƒüu√ß"></div>
                        <div><label for="school-input" class="block mb-2 text-sm font-medium text-gray-300">Okul</label><input type="text" id="school-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="√ñrn: Turgut √ñzal Anadolu Lisesi"></div>
                        <div><label for="branch-input" class="block mb-2 text-sm font-medium text-gray-300">Bran≈ü</label><input type="text" id="branch-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="√ñrn: T√ºrk Dili ve Edebiyatƒ±"></div>
                        <button id="save-settings-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ayarlarƒ± Kaydet</button>
                        <div class="pt-6">
                            <h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-4">Veri Y√∂netimi</h3>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="import-schedule-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ders Programƒ± ƒ∞√ße Aktar</button>
                                <button id="import-calendar-button" class="w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Akademik Takvim ƒ∞√ße Aktar</button>
                            </div>
                            <input type="file" id="file-importer" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
            </div>
        </div>
         <div class="w-full text-right pr-4 mt-2">
             <p class="neon-text">by MOD</p>
        </div>
    </div>

    <div id="lesson-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden"><div class="bg-slate-800 p-6 rounded-lg shadow-xl w-11/12 md:w-1/3"><h2 id="modal-title" class="text-xl font-bold mb-4">Dersi D√ºzenle</h2><div class="space-y-4"><div><label for="lesson-name" class="block mb-2 text-sm font-medium">Ders Adƒ± ve Sƒ±nƒ±f</label><input type="text" id="lesson-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="√ñrn: TDE12 (12-E)"></div><div><label for="lesson-note" class="block mb-2 text-sm font-medium">Bu Derse Ait Not</label><div class="flex items-center gap-2"><input type="date" id="note-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"><button id="today-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Bug√ºn</button></div><textarea id="lesson-note" rows="4" class="mt-2 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="√ñdev, hatƒ±rlatma, sƒ±nav tarihi..."></textarea></div><div class="flex justify-between items-center mt-6"><button id="delete-lesson-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Dersi Sil</button><div><button id="cancel-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">ƒ∞ptal</button><button id="save-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Kaydet</button></div></div></div></div></div>
    <div id="notification-container" class="fixed bottom-5 right-5 space-y-3 z-50"></div>

    <script type="module">
        // Firebase SDK'larƒ±nƒ± import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE KURULUMU ---
        const firebaseConfig = {
            apiKey: "AIzaSyA86dtrt_qXJc4lhpOtVhISfPH5MBI9wxo",
            authDomain: "okulrehberi-6006b.firebaseapp.com",
            projectId: "okulrehberi-6006b",
            storageBucket: "okulrehberi-6006b.appspot.com",
            messagingSenderId: "318293016872",
            appId: "1:318293016872:web:2b8f5113dece23014e901d",
            measurementId: "G-QJZYVTHZBJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        let unsubscribeFromData = null; // onSnapshot listener'ƒ±nƒ± tutmak i√ßin

        const authContainer = document.getElementById('auth-container');
        const appWrapper = document.getElementById('app-wrapper');
        const authError = document.getElementById('auth-error');

        // Kullanƒ±cƒ± durumunu dinle (Giri≈ü yaptƒ± mƒ±, yapmadƒ± mƒ±?)
        onAuthStateChanged(auth, user => {
            if (user) {
                // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
                userId = user.uid;
                authContainer.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                loadData(); // Verileri Firestore'dan y√ºkle
            } else {
                // Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yapmƒ±≈ü
                userId = null;
                authContainer.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                if (unsubscribeFromData) {
                    unsubscribeFromData(); // Eski listener'ƒ± temizle
                    unsubscribeFromData = null;
                }
                resetAppData(); // Uygulama verilerini temizle
            }
        });

        // Hata mesajƒ±nƒ± g√∂ster
        const showAuthError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
        };

        // Giri≈ü Yapma
        document.getElementById('login-button').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Giri≈ü hatasƒ±:", error);
                    showAuthError("E-posta veya ≈üifre hatalƒ±.");
                });
        });

        // Kayƒ±t Olma
        document.getElementById('register-button').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Kayƒ±t hatasƒ±:", error);
                     if (error.code === 'auth/weak-password') {
                        showAuthError('≈ûifre en az 6 karakter olmalƒ±dƒ±r.');
                    } else if (error.code === 'auth/email-already-in-use') {
                        showAuthError('Bu e-posta adresi zaten kullanƒ±lƒ±yor.');
                    } else {
                        showAuthError('Kayƒ±t ba≈üarƒ±sƒ±z oldu.');
                    }
                });
        });

        // √áƒ±kƒ±≈ü Yapma
        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- UYGULAMA MANTIƒûI (Firebase ile g√ºncellendi) ---

        let scheduleData = {};
        let academicCalendar = [];

        // Veriyi Firestore'a kaydet
        const saveDataToFirestore = async () => {
            if (!userId) return;
            const appData = {
                schedule: scheduleData,
                calendar: academicCalendar,
                settings: {
                    name: document.getElementById('name-input').value,
                    school: document.getElementById('school-input').value,
                    branch: document.getElementById('branch-input').value,
                }
            };
            try {
                const userDocRef = doc(db, "users", userId);
                await setDoc(userDocRef, { data: appData });
            } catch (error) {
                console.error("Veri kaydetme hatasƒ±:", error);
                createNotification("Veri kaydedilemedi!", "error");
            }
        };

        // Veriyi Firestore'dan y√ºkle ve deƒüi≈üiklikleri dinle
        const loadData = () => {
            if (!userId) return;
            
            // Eƒüer zaten bir listener varsa, √∂nce onu durdur
            if (unsubscribeFromData) {
                unsubscribeFromData();
            }

            const userDocRef = doc(db, "users", userId);
            
            // onSnapshot ile veritabanƒ±ndaki deƒüi≈üiklikleri anlƒ±k olarak dinle
            unsubscribeFromData = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const firestoreData = docSnap.data().data;
                    scheduleData = firestoreData.schedule || {};
                    academicCalendar = firestoreData.calendar || [];
                    if(firestoreData.settings) {
                        document.getElementById('name-input').value = firestoreData.settings.name || '';
                        document.getElementById('school-input').value = firestoreData.settings.school || '';
                        document.getElementById('branch-input').value = firestoreData.settings.branch || '';
                        updateHeaderInfo();
                    }
                } else {
                    console.log("Kullanƒ±cƒ± i√ßin veri bulunamadƒ±, yeni veri olu≈üturulacak.");
                    resetAppData();
                }
                renderSchedule();
                renderAcademicCalendar();
            });
        };
        
        // Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yaptƒ±ƒüƒ±nda uygulama aray√ºz√ºn√º sƒ±fƒ±rla
        const resetAppData = () => {
            scheduleData = {};
            academicCalendar = [];
            document.getElementById('name-input').value = '';
            document.getElementById('school-input').value = '';
            document.getElementById('branch-input').value = '';
            updateHeaderInfo();
            renderSchedule();
            renderAcademicCalendar();
        };

        // --- GERƒ∞ KALAN KOD (localStorage yerine saveDataToFirestore kullanacak ≈üekilde g√ºncellendi) ---
        
        const days = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma'];
        const hours = ['09:00 - 09:40', '09:50 - 10:30', '10:40 - 11:20', '11:30 - 12:10', '12:20 - 13:00', '13:40 - 14:20', '14:30 - 15:10', '15:20 - 16:00'];
        const publicHolidays = [{ date: "2025-10-28", event: "Cumhuriyet Bayramƒ± Arifesi (√ñƒüleden sonra)" }, { date: "2025-10-29", event: "Cumhuriyet Bayramƒ±" }, { date: "2025-12-31", event: "Yƒ±lba≈üƒ± Gecesi" }, { date: "2026-01-01", event: "Yƒ±lba≈üƒ±" }, { date: "2026-03-19", event: "Ramazan Bayramƒ± Arifesi (√ñƒüleden sonra)" }, { date: "2026-03-20", event: "Ramazan Bayramƒ± 1. G√ºn" }, { date: "2026-03-21", event: "Ramazan Bayramƒ± 2. G√ºn" }, { date: "2026-03-22", event: "Ramazan Bayramƒ± 3. G√ºn" }, { date: "2026-04-23", event: "Ulusal Egemenlik ve √áocuk Bayramƒ±" }, { date: "2026-05-01", event: "Emek ve Dayanƒ±≈üma G√ºn√º" }, { date: "2026-05-19", event: "Atat√ºrk‚Äô√º Anma, Gen√ßlik ve Spor Bayramƒ±" }, { date: "2026-05-26", event: "Kurban Bayramƒ± Arifesi (√ñƒüleden sonra)" }, { date: "2026-05-27", event: "Kurban Bayramƒ± 1. G√ºn" }, { date: "2026-05-28", event: "Kurban Bayramƒ± 2. G√ºn" }, { date: "2026-05-29", event: "Kurban Bayramƒ± 3. G√ºn" }, { date: "2026-05-30", event: "Kurban Bayramƒ± 4. G√ºn" }, { date: "2026-07-15", event: "Demokrasi ve Mill√Æ Birlik G√ºn√º" }, { date: "2026-08-30", event: "Zafer Bayramƒ±" }];
        const classColors = { '12-C': 'border-2 border-blue-500', '9-C': 'border-2 border-green-500', '9-I': 'border-2 border-yellow-500', '9-D': 'border-2 border-red-500' };
        let currentCell = { day: null, hourIndex: null };
        const scheduleBody = document.getElementById('schedule-body');
        const modal = document.getElementById('lesson-modal');
        const modalTitle = document.getElementById('modal-title');
        const lessonNameInput = document.getElementById('lesson-name');
        const noteDateInput = document.getElementById('note-date');
        const lessonNoteInput = document.getElementById('lesson-note');

        const startApp = () => {
            renderPublicHolidays();
            updateTimeAndLessons();
            setInterval(updateTimeAndLessons, 1000);
        };

        const renderSchedule = () => {
            scheduleBody.innerHTML = '';
            hours.forEach((hour, hourIndex) => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('th');
                timeCell.textContent = hour;
                timeCell.classList.add('time-header');
                row.appendChild(timeCell);
                days.forEach(day => {
                    const cell = document.createElement('td');
                    cell.dataset.day = day;
                    cell.dataset.hourIndex = hourIndex;
                    const key = `${day}-${hourIndex}`;
                    const lesson = scheduleData[key];
                    if (lesson && lesson.name) {
                        cell.textContent = lesson.name;
                        const today = new Date().toISOString().split('T')[0];
                        if (lesson.notes && lesson.notes[today]) {
                            cell.innerHTML += `<span class="note-indicator">üìù</span>`;
                        }
                        const classNameMatch = lesson.name.match(/\(([^)]+)\)/);
                        if (classNameMatch && classNameMatch[1]) {
                            const className = classNameMatch[1].trim();
                            if (classColors[className]) {
                                cell.className += ` ${classColors[className]}`;
                            }
                        }
                    }
                    cell.addEventListener('click', () => openModal(day, hourIndex));
                    row.appendChild(cell);
                });
                scheduleBody.appendChild(row);
            });
        };

        const renderAcademicCalendar = () => {
            const calendarList = document.getElementById('academic-calendar-list');
            calendarList.innerHTML = '';
            if (!academicCalendar || academicCalendar.length === 0) {
                calendarList.innerHTML = '<li class="text-center text-gray-400">Akademik takvim verisi bulunmuyor. L√ºtfen Ayarlar\'dan i√ße aktarƒ±n.</li>';
                return;
            }
            academicCalendar.forEach(item => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center flex-wrap';
                const dateText = item.endDate ? `${formatDate(item.date)} - ${formatDate(item.endDate)}` : formatDate(item.date);
                li.innerHTML = `<span class="font-semibold text-white">${item.event}</span><span class="text-sm text-blue-300 text-right">${dateText}</span>`;
                calendarList.appendChild(li);
});
        };

        const renderPublicHolidays = () => {
            const holidaysList = document.getElementById('public-holidays-list');
            holidaysList.innerHTML = '';
            publicHolidays.forEach(holiday => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center flex-wrap';
                li.innerHTML = `<span class="font-semibold text-white">${holiday.event}</span><span class="text-sm text-blue-300 text-right">${formatDate(holiday.date)}</span>`;
                holidaysList.appendChild(li);
            });
        };

        const updateTimeAndLessons = () => {
            const now = new Date();
            const dayName = days[now.getDay() - 1];
            const currentTime = now.toTimeString().slice(0, 5);
            document.getElementById('current-time').textContent = `${now.toLocaleDateString('tr-TR')} ${currentTime}`;
            document.querySelectorAll('.current-lesson').forEach(el => el.classList.remove('current-lesson'));
            document.getElementById('current-lesson-info').textContent = 'Ders Yok';
            document.getElementById('current-lesson-note-preview').textContent = '';
            document.getElementById('next-lesson-info').textContent = 'Ders Yok';
            for (let hourIndex = 0; hourIndex < hours.length; hourIndex++) {
                const [start, end] = hours[hourIndex].split(' - ');
                const key = `${dayName}-${hourIndex}`;
                const lesson = scheduleData[key];
                if (currentTime >= start && currentTime <= end) {
                    const currentCellEl = document.querySelector(`td[data-day="${dayName}"][data-hour-index="${hourIndex}"]`);
                    if (currentCellEl) currentCellEl.classList.add('current-lesson');
                    if (lesson && lesson.name) {
                        document.getElementById('current-lesson-info').textContent = lesson.name;
                        const todayStr = now.toISOString().split('T')[0];
                        if (lesson.notes && lesson.notes[todayStr]) {
                            document.getElementById('current-lesson-note-preview').textContent = `üìù Not: ${lesson.notes[todayStr]}`;
                        }
                    }
                }
                if (currentTime < start && document.getElementById('next-lesson-info').textContent === 'Ders Yok') {
                    if (lesson && lesson.name) {
                        document.getElementById('next-lesson-info').textContent = `${start} - ${lesson.name}`;
                    }
                }
            }
            checkReminders(now);
        };
        
        const openModal = (day, hourIndex) => {
            currentCell = { day, hourIndex };
            const key = `${day}-${hourIndex}`;
            const lesson = scheduleData[key] || { name: '', notes: {} };
            const today = new Date().toISOString().split('T')[0];
            modalTitle.textContent = `${day} - ${hours[hourIndex]}`;
            lessonNameInput.value = lesson.name;
            noteDateInput.value = today;
            lessonNoteInput.value = lesson.notes[today] || '';
            modal.classList.remove('hidden');
        };

        const closeModal = () => modal.classList.add('hidden');
        
        document.getElementById('save-button').addEventListener('click', () => {
            const { day, hourIndex } = currentCell;
            const key = `${day}-${hourIndex}`;
            if (!scheduleData[key]) scheduleData[key] = { name: '', notes: {} };
            scheduleData[key].name = lessonNameInput.value.trim();
            const noteDate = noteDateInput.value;
            const noteText = lessonNoteInput.value.trim();
            if (noteText) scheduleData[key].notes[noteDate] = noteText;
            else delete scheduleData[key].notes[noteDate];
            saveDataToFirestore();
            closeModal();
        });

        document.getElementById('delete-lesson-button').addEventListener('click', () => {
            const { day, hourIndex } = currentCell;
            const key = `${day}-${hourIndex}`;
            delete scheduleData[key];
            saveDataToFirestore();
            closeModal();
        });

        document.getElementById('today-button').addEventListener('click', () => {
            noteDateInput.value = new Date().toISOString().split('T')[0];
            noteDateInput.dispatchEvent(new Event('change'));
        });

        noteDateInput.addEventListener('change', (e) => {
            const { day, hourIndex } = currentCell;
            const key = `${day}-${hourIndex}`;
            const lesson = scheduleData[key] || { notes: {} };
            lessonNoteInput.value = lesson.notes[e.target.value] || '';
        });

        document.getElementById('cancel-button').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        document.getElementById('save-settings-button').addEventListener('click', () => {
            saveDataToFirestore();
            createNotification('Ayarlar ba≈üarƒ±yla kaydedildi!', 'success');
        });
            
        const updateHeaderInfo = () => {
            document.getElementById('user-name').textContent = document.getElementById('name-input').value || 'ƒ∞sim Soyisim';
            document.getElementById('user-branch').textContent = document.getElementById('branch-input').value || 'Bran≈ü';
        };

        window.changeTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        };

        const createNotification = (message, type = 'info', duration = 5000) => {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', reminder: 'bg-yellow-500 text-black' };
            notif.className = `notification ${colors[type]} text-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-2`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.classList.remove('opacity-0', 'translate-y-2'), 100);
            setTimeout(() => {
                notif.classList.add('opacity-0');
                notif.addEventListener('transitionend', () => notif.remove());
            }, duration);
            notif.addEventListener('click', () => {
                notif.classList.add('opacity-0');
                notif.addEventListener('transitionend', () => notif.remove());
            });
        };

        const checkReminders = (now) => {
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            academicCalendar.forEach(item => {
                const eventDate = new Date(item.date);
                const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays <= 7) {
                    const reminderKey = `reminder-academic-${item.date}`;
                    if (!sessionStorage.getItem(reminderKey)) {
                        createNotification(diffDays === 0 ? `Bug√ºn: ${item.event}` : `${diffDays} g√ºn sonra: ${item.event}`, 'reminder', 10000);
                        sessionStorage.setItem(reminderKey, 'true');
                    }
                }
            });
            publicHolidays.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                const diffDays = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays === 1) {
                    const reminderKey = `reminder-holiday-${holiday.date}`;
                    if (!sessionStorage.getItem(reminderKey)) {
                        createNotification(`Yarƒ±n: ${holiday.event}`, 'reminder', 10000);
                        sessionStorage.setItem(reminderKey, 'true');
                    }
                }
            });
        };
            
        const fileImporter = document.getElementById('file-importer');
        let importType = '';

        document.getElementById('import-schedule-button').addEventListener('click', () => {
            importType = 'schedule';
            fileImporter.click();
        });

        document.getElementById('import-calendar-button').addEventListener('click', () => {
            importType = 'calendar';
            fileImporter.click();
        });

        fileImporter.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = JSON.parse(e.target.result);
                    if (importType === 'schedule') scheduleData = content;
                    else if (importType === 'calendar') academicCalendar = content;
                    saveDataToFirestore();
                    createNotification('Veri ba≈üarƒ±yla i√ße aktarƒ±ldƒ±.', 'success');
                } catch (error) {
                    createNotification('Ge√ßersiz dosya formatƒ±.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        });
            
        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric', weekday: 'long' });
        };

        startApp();

    </script>
</body>
</html>

