<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş İnteraktif Ders Programı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            padding: 1rem;
            padding-bottom: 4rem; /* Alt güvenlik boşluğu artırıldı */
        }
        .app-container {
            max-width: 1400px;
            margin: auto;
            background-color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding-top: 1rem;
            position: relative;
        }
        .settings-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
        }
        .neon-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: #fff;
            text-shadow:
                0 0 5px #00aaff,
                0 0 10px #00aaff,
                0 0 20px #00aaff,
                0 0 40px #00aaff,
                0 0 80px #00aaff;
            animation: flicker 1.5s infinite alternate;
        }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 4px #00aaff, 0 0 11px #00aaff, 0 0 19px #00aaff, 0 0 40px #00aaff, 0 0 80px #00aaff; }
            20%, 24%, 55% { text-shadow: none; }
        }
        .tab-button { background-color: #374151; transition: all 0.3s ease; }
        .tab-button.active { background-color: #2563EB; color: #FFFFFF; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #2c3e50; padding: 8px; text-align: center; height: 60px; position: relative; transition: background-color 0.3s; }
        th { background-color: #2c3e50; color: white; font-weight: bold; }
        th.day-header, th.time-header { border: 2px solid #10B981; }
        td:hover { background-color: #4a5568; cursor: pointer; }
        .current-lesson { background-color: #2f855a !important; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(47, 133, 90, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(47, 133, 90, 0); }
            100% { box-shadow: 0 0 0 0 rgba(47, 133, 90, 0); }
        }
        .note-indicator { position: absolute; bottom: 4px; left: 4px; font-size: 0.8rem; }
        .modal { background-color: rgba(0,0,0,0.7); z-index: 100; }
        .notification { transition: opacity 0.5s, transform 0.5s; }
        .header-info-container { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-bottom: 1.5rem; }
        .settings-modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Mobil Cihazlar İçin Özel Stiller */
        @media (max-width: 640px) {
            body { padding: 0.5rem; padding-bottom: 4rem; }
            .app-container { padding: 1rem; }
            th, td {
                font-size: 0.75rem;
                padding: 4px 2px;
                min-width: 50px;
                height: 50px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .time-header {
                font-size: 0.65rem;
                white-space: normal; /* Saatlerin tam görünmesi için */
            }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="auth-container" class="max-w-md mx-auto mt-10 p-4">
        <div class="bg-slate-800 p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold text-center text-white mb-6">Giriş Yap veya Kayıt Ol</h2>
            <div id="auth-error" class="bg-red-500 text-white p-3 rounded-lg mb-4 text-center hidden"></div>
            <div class="space-y-4">
                <div><label for="email" class="block mb-2 text-sm font-medium text-gray-300">E-posta</label><input type="email" id="email" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="ornek@eposta.com" required></div>
                <div><label for="password" class="block mb-2 text-sm font-medium text-gray-300">Şifre</label><input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="••••••••" required></div>
                <div class="flex flex-col sm:flex-row gap-4 pt-2">
                    <button id="login-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Giriş Yap</button>
                    <button id="register-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Kayıt Ol</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <div class="app-container">
            <button id="settings-icon-button" class="settings-button text-gray-300 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            <div class="header-info-container text-center">
                <div>
                    <h1 id="user-name" class="text-3xl font-bold text-white"></h1>
                    <p id="user-branch" class="text-lg text-blue-300"></p>
                </div>
                <p class="text-md text-gray-400">Derslerinizi ve notlarınızı kolayca yönetin.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-blue-300">Tarih ve Saat</p><p id="current-time" class="text-xl font-mono"></p></div>
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-green-300">Şu Anki Ders</p><p id="current-lesson-info" class="text-xl"></p><p id="current-lesson-note-preview" class="text-sm text-yellow-300 mt-1 truncate"></p></div>
                <div class="bg-slate-700 p-4 rounded-lg"><p class="font-semibold text-purple-300">Sonraki Ders</p><p id="next-lesson-info" class="text-xl"></p></div>
            </div>
            <nav class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                <button class="tab-button active text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('schedule')">Ders Programı</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('class-notes')">Sınıf Notları</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('calendar')">Akademik Takvim</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg" onclick="changeTab('holidays')">Resmî Tatiller</button>
                <button class="tab-button text-gray-300 py-3 px-4 font-medium rounded-lg col-span-2 md:col-span-4" onclick="changeTab('acquisitions')">Günlük Kazanımlar</button>
            </nav>
            
            <div id="future-notes-container" class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-center text-white border-b border-gray-600 pb-2">Yaklaşan Notlar</h3>
                <ul id="future-notes-list" class="space-y-2 max-h-48 overflow-y-auto"></ul>
            </div>

            <div id="app-content">
                <div id="schedule-tab" class="tab-content"><div class="overflow-x-auto"><table class="min-w-full bg-slate-800 border-collapse"><thead><tr id="schedule-header"></tr></thead><tbody id="schedule-body"></tbody></table></div></div>
                
                <div id="class-notes-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-center text-white">Sınıf Not Defterleri</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-8 rounded-lg" onclick="openNotesModal(9)">9. Sınıf</button>
                        <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-8 rounded-lg" onclick="openNotesModal(10)">10. Sınıf</button>
                        <button class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-8 rounded-lg" onclick="openNotesModal(11)">11. Sınıf</button>
                        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-8 rounded-lg" onclick="openNotesModal(12)">12. Sınıf</button>
                    </div>
                </div>

                <div id="calendar-tab" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4 text-center text-white">Akademik Takvim</h2><ul id="academic-calendar-list" class="space-y-3"></ul></div>
                <div id="holidays-tab" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4 text-center text-white">Resmî Tatiller (2025-2026)</h2><ul id="public-holidays-list" class="space-y-3"></ul></div>
                
                <div id="acquisitions-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-center text-white">Günlük Kazanımlar</h2>
                    <div class="flex justify-center flex-wrap gap-4 mb-4">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="showAcquisitions(9)">9. Sınıf</button>
                        <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="showAcquisitions(10)">10. Sınıf</button>
                        <button class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" onclick="showAcquisitions(11)">11. Sınıf</button>
                        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" onclick="showAcquisitions(12)">12. Sınıf</button>
                    </div>
                    <div id="acquisitions-content" class="bg-slate-800 p-4 rounded-lg min-h-[200px]"></div>
                </div>
            </div>
        </div>
         <div class="w-full text-right pr-4 mt-2"><p class="neon-text">by MOD</p></div>
    </div>
    
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden p-4">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full md:w-1/2 relative settings-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Ayarlar</h2>
                <div class="flex items-center gap-x-4">
                    <button id="logout-button" class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Çıkış Yap</button>
                    <button id="close-settings-button" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                </div>
            </div>
            <div class="max-w-md mx-auto space-y-4">
                <div><label for="name-input" class="block mb-2 text-sm font-medium text-gray-300">İsim Soyisim</label><input type="text" id="name-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="Örn: Muhammed Ömer Doğuç"></div>
                <div><label for="school-input" class="block mb-2 text-sm font-medium text-gray-300">Okul</label><input type="text" id="school-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="Örn: Turgut Özal Anadolu Lisesi"></div>
                <div><label for="branch-input" class="block mb-2 text-sm font-medium text-gray-300">Branş</label><input type="text" id="branch-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="Örn: Türk Dili ve Edebiyatı"></div>
                <button id="save-settings-button" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ayarları Kaydet</button>
                <div class="pt-6">
                    <h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-4">Veri Yönetimi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="import-schedule-button" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Ders Programı</button>
                        <button id="import-calendar-button" class="w-full text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Akademik Takvim</button>
                        <button id="import-acquisitions-9-button" class="w-full text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">9. Sınıf Kazanım</button>
                        <button id="import-acquisitions-10-button" class="w-full text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">10. Sınıf Kazanım</button>
                        <button id="import-acquisitions-11-button" class="w-full text-white bg-yellow-500 hover:bg-yellow-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">11. Sınıf Kazanım</button>
                        <button id="import-acquisitions-12-button" class="w-full text-white bg-red-500 hover:bg-red-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">12. Sınıf Kazanım</button>
                    </div>
                    <input type="file" id="file-importer" class="hidden" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <div id="lesson-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden"><div class="bg-slate-800 p-6 rounded-lg shadow-xl w-11/12 md:w-1/3"><h2 id="modal-title" class="text-xl font-bold mb-4">Dersi Düzenle</h2><div class="space-y-4"><div><label for="lesson-name" class="block mb-2 text-sm font-medium">Ders Adı ve Sınıf</label><input type="text" id="lesson-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="Örn: TDE12 (12-E)"></div><div><label for="lesson-note" class="block mb-2 text-sm font-medium">Bu Derse Ait Not</label><div class="flex items-center gap-2"><input type="date" id="note-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5"><button id="today-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Bugün</button></div><textarea id="lesson-note" rows="4" class="mt-2 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" placeholder="Ödev, hatırlatma, sınav tarihi..."></textarea></div><div class="flex justify-between items-center mt-6"><button id="delete-lesson-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Dersi Sil</button><div><button id="cancel-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">İptal</button><button id="save-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Kaydet</button></div></div></div></div></div>
    
    <div id="class-notes-modal" class="modal fixed inset-0 bg-slate-900 hidden p-4 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="class-notes-title" class="text-3xl font-bold text-white">Sınıf Notları</h2>
                <button id="close-class-notes-button" class="text-gray-400 hover:text-white text-4xl font-bold">&times;</button>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg mb-6">
                <input id="new-note-title" type="text" placeholder="Başlık" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 mb-2">
                <textarea id="new-note-content" placeholder="Notunuzu buraya yazın..." rows="3" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5"></textarea>
                <button id="add-note-button" class="w-full mt-2 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Not Ekle</button>
            </div>
            <div id="notes-grid" class="notes-grid"></div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden p-4">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full sm:w-1/3 text-center">
            <h2 class="text-xl font-bold mb-4 text-white">Emin misiniz?</h2>
            <p id="confirmation-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">İptal</button>
                <button id="confirm-delete-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">Evet, Sil</button>
            </div>
        </div>
    </div>

    <div id="notification-container" class="fixed bottom-5 right-5 space-y-3 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA86dtrt_qXJc4lhpOtVhISfPH5MBI9wxo",
            authDomain: "okulrehberi-6006b.firebaseapp.com",
            projectId: "okulrehberi-6006b",
            storageBucket: "okulrehberi-6006b.appspot.com",
            messagingSenderId: "318293016872",
            appId: "1:318293016872:web:2b8f5113dece23014e901d",
            measurementId: "G-QJZYVTHZBJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        let unsubscribeFromData = null;

        const authContainer = document.getElementById('auth-container');
        const appWrapper = document.getElementById('app-wrapper');
        const authError = document.getElementById('auth-error');

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                authContainer.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                loadData();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                if (unsubscribeFromData) unsubscribeFromData();
                resetAppData();
            }
        });

        // --- AUTH & SETTINGS ---
        const showAuthError = (message) => { authError.textContent = message; authError.classList.remove('hidden'); };
        document.getElementById('login-button').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(err => showAuthError("E-posta veya şifre hatalı.")));
        document.getElementById('register-button').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(err => showAuthError(err.code === 'auth/weak-password' ? 'Şifre en az 6 karakter olmalıdır.' : 'Kayıt başarısız oldu.')));
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        const settingsModal = document.getElementById('settings-modal');
        document.getElementById('settings-icon-button').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings-button').addEventListener('click', () => settingsModal.classList.add('hidden'));

        // --- DATA MANAGEMENT ---
        let scheduleData = {}, academicCalendar = [], acquisitions9Data = [], acquisitions10Data = [], acquisitions11Data = [], acquisitions12Data = [], classNotes = {};
        
        const saveDataToFirestore = async () => {
            if (!userId) return;
            const appData = {
                schedule: scheduleData,
                calendar: academicCalendar,
                acquisitions9: acquisitions9Data,
                acquisitions10: acquisitions10Data,
                acquisitions11: acquisitions11Data,
                acquisitions12: acquisitions12Data,
                classNotes: classNotes,
                settings: {
                    name: document.getElementById('name-input').value,
                    school: document.getElementById('school-input').value,
                    branch: document.getElementById('branch-input').value,
                }
            };
            try { await setDoc(doc(db, "users", userId), { data: appData }); } 
            catch (error) { createNotification("Veri kaydedilemedi!", "error"); }
        };

        const loadData = () => {
            if (!userId) return;
            if (unsubscribeFromData) unsubscribeFromData();
            unsubscribeFromData = onSnapshot(doc(db, "users", userId), (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data().data || {};
                    scheduleData = d.schedule || {};
                    academicCalendar = d.calendar || [];
                    acquisitions9Data = d.acquisitions9 || [];
                    acquisitions10Data = d.acquisitions10 || [];
                    acquisitions11Data = d.acquisitions11 || [];
                    acquisitions12Data = d.acquisitions12 || [];
                    classNotes = d.classNotes || {};
                    if (d.settings) {
                        document.getElementById('name-input').value = d.settings.name || '';
                        document.getElementById('school-input').value = d.settings.school || '';
                        document.getElementById('branch-input').value = d.settings.branch || '';
                        updateHeaderInfo();
                    }
                    if(acquisitions9Data.length === 0) acquisitions9Data = initialAcquisitions9;
                    if(acquisitions12Data.length === 0) acquisitions12Data = initialAcquisitions12;
                } else {
                    resetAppData();
                }
                renderAll();
            });
        };
        
        const resetAppData = () => {
            scheduleData = {}; academicCalendar = []; classNotes = {};
            acquisitions9Data = initialAcquisitions9; acquisitions10Data = []; acquisitions11Data = []; acquisitions12Data = initialAcquisitions12;
            ['name-input', 'school-input', 'branch-input'].forEach(id => document.getElementById(id).value = '');
            updateHeaderInfo();
            renderAll();
        };

        const renderAll = () => {
            renderSchedule(); 
            renderAcademicCalendar(); 
            renderFutureNotes();
            if (document.getElementById('acquisitions-tab').classList.contains('hidden') === false) {
                 showAcquisitions(9); // Re-render if visible
            }
             if (currentGrade && !document.getElementById('class-notes-modal').classList.contains('hidden')) {
                renderClassNotes(currentGrade);
            }
        };
        
        // --- UI & RENDER FUNCTIONS ---
        const days = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma'];
        const shortDays = ['Pzt', 'Sal', 'Çar', 'Per', 'Cum'];
        const hours = ['09:00 - 09:40', '09:50 - 10:30', '10:40 - 11:20', '11:30 - 12:10', '12:20 - 13:00', '13:40 - 14:20', '14:30 - 15:10', '15:20 - 16:00'];
        const publicHolidays = [{ date: "2025-10-28", event: "Cumhuriyet Bayramı Arifesi (Öğleden sonra)" }, { date: "2025-10-29", event: "Cumhuriyet Bayramı" }, { date: "2025-12-31", event: "Yılbaşı Gecesi" }, { date: "2026-01-01", event: "Yılbaşı" }, { date: "2026-03-19", event: "Ramazan Bayramı Arifesi (Öğleden sonra)" }, { date: "2026-03-20", event: "Ramazan Bayramı 1. Gün" }, { date: "2026-03-21", event: "Ramazan Bayramı 2. Gün" }, { date: "2026-03-22", event: "Ramazan Bayramı 3. Gün" }, { date: "2026-04-23", event: "Ulusal Egemenlik ve Çocuk Bayramı" }, { date: "2026-05-01", event: "Emek ve Dayanışma Günü" }, { date: "2026-05-19", event: "Atatürk’ü Anma, Gençlik ve Spor Bayramı" }, { date: "2026-05-26", event: "Kurban Bayramı Arifesi (Öğleden sonra)" }, { date: "2026-05-27", event: "Kurban Bayramı 1. Gün" }, { date: "2026-05-28", event: "Kurban Bayramı 2. Gün" }, { date: "2026-05-29", event: "Kurban Bayramı 3. Gün" }, { date: "2026-05-30", event: "Kurban Bayramı 4. Gün" }, { date: "2026-07-15", event: "Demokrasi ve Millî Birlik Günü" }, { date: "2026-08-30", event: "Zafer Bayramı" }];
        const classColors = { '12-C': 'border-2 border-blue-500', '9-C': 'border-2 border-green-500', '9-I': 'border-2 border-yellow-500', '9-D': 'border-2 border-red-500', '9-B': 'border-2 border-purple-500', '9-H': 'border-2 border-pink-500', '12-E': 'border-2 border-indigo-500', '9-E': 'border-2 border-teal-500', '12-F': 'border-2 border-orange-500' };
        let currentCell = { day: null, hourIndex: null };
        
        const startApp = () => {
            renderPublicHolidays();
            updateTimeAndLessons();
            setInterval(updateTimeAndLessons, 1000);
            changeTab('schedule');
            window.addEventListener('resize', renderSchedule); // Re-render on resize for mobile view
        };

        const renderSchedule = () => {
            const isMobile = window.innerWidth < 640;
            const scheduleHeader = document.getElementById('schedule-header');
            scheduleHeader.innerHTML = '';
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = '';

            let headerHTML = '<th class="time-header">Saat</th>';
            (isMobile ? shortDays : days).forEach(day => { headerHTML += `<th class="day-header">${day}</th>`; });
            scheduleHeader.innerHTML = headerHTML;
            
            hours.forEach((hour, hourIndex) => {
                const row = document.createElement('tr');
                const timeCell = document.createElement('th');
                timeCell.textContent = hour;
                timeCell.classList.add('time-header');
                row.appendChild(timeCell);
                days.forEach(day => {
                    const cell = document.createElement('td');
                    cell.dataset.day = day; cell.dataset.hourIndex = hourIndex;
                    const key = `${day}-${hourIndex}`;
                    const lesson = scheduleData[key];
                    if (lesson && lesson.name) {
                        const match = lesson.name.match(/\(([^)]+)\)/);
                        cell.textContent = (isMobile && match) ? match[1].replace(/\s/g, '') : lesson.name;
                        let hasUpcomingNote = false;
                        if (lesson.notes) {
                            const today = new Date(); today.setHours(0, 0, 0, 0);
                            for (const noteDateStr in lesson.notes) {
                                if (new Date(noteDateStr.replace(/-/g, '/')) >= today) { hasUpcomingNote = true; break; }
                            }
                        }
                        if (hasUpcomingNote) cell.innerHTML += `<span class="note-indicator">📝</span>`;
                        if (match && classColors[match[1].trim()]) cell.className += ` ${classColors[match[1].trim()]}`;
                    }
                    cell.addEventListener('click', () => openModal(day, hourIndex));
                    row.appendChild(cell);
                });
                scheduleBody.appendChild(row);
            });
        };
        
        const renderFutureNotes = () => {
            const list = document.getElementById('future-notes-list');
            list.innerHTML = '';
            const futureNotes = [];
            const today = new Date(); today.setHours(0, 0, 0, 0);
            for (const key in scheduleData) {
                const lesson = scheduleData[key];
                if (lesson.notes) {
                    for (const noteDateStr in lesson.notes) {
                        if (new Date(noteDateStr.replace(/-/g, '/')) >= today) {
                            futureNotes.push({ date: noteDateStr, lessonName: lesson.name, note: lesson.notes[noteDateStr], key: key });
                        }
                    }
                }
            }
            futureNotes.sort((a, b) => new Date(a.date) - new Date(b.date));
            if (futureNotes.length === 0) { list.innerHTML = '<li class="text-center text-gray-400">Yaklaşan notunuz bulunmuyor.</li>'; return; }
            futureNotes.forEach(note => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700 p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-600';
                li.innerHTML = `<div><p class="font-semibold text-white">${formatDate(note.date, { weekday: 'short', day: '2-digit', month: 'short' })} - ${note.lessonName}</p><p class="text-sm text-yellow-300 truncate">${note.note}</p></div>`;
                li.addEventListener('click', () => {
                    const [day, hourIndex] = note.key.split('-');
                    openModal(day, parseInt(hourIndex, 10));
                    document.getElementById('note-date').value = note.date;
                    document.getElementById('lesson-note').value = note.note;
                });
                list.appendChild(li);
            });
        };

        const renderAcademicCalendar = () => {
            const list = document.getElementById('academic-calendar-list');
            list.innerHTML = '';
            if (!academicCalendar || academicCalendar.length === 0) { list.innerHTML = '<li class="text-center text-gray-400">Akademik takvim verisi yüklenmedi.</li>'; return; }
            academicCalendar.forEach(item => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center flex-wrap';
                const dateText = item.endDate ? `${formatDate(item.date)} - ${formatDate(item.endDate)}` : formatDate(item.date);
                li.innerHTML = `<span class="font-semibold text-white">${item.event}</span><span class="text-sm text-blue-300 text-right">${dateText}</span>`;
                list.appendChild(li);
            });
        };

        const renderPublicHolidays = () => {
            const list = document.getElementById('public-holidays-list');
            list.innerHTML = '';
            publicHolidays.forEach(holiday => {
                const li = document.createElement('li');
                li.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center flex-wrap';
                li.innerHTML = `<span class="font-semibold text-white">${holiday.event}</span><span class="text-sm text-blue-300 text-right">${formatDate(holiday.date)}</span>`;
                list.appendChild(li);
            });
        };

        window.showAcquisitions = (grade) => {
            const container = document.getElementById('acquisitions-content');
            const dataMap = { 9: acquisitions9Data, 10: acquisitions10Data, 11: acquisitions11Data, 12: acquisitions12Data };
            const data = dataMap[grade] || [];
            const schoolStartDate = new Date('2025-09-08'); 
            const today = new Date();
            if (today < schoolStartDate) { container.innerHTML = `<p class="text-center text-gray-400">2025-2026 eğitim-öğretim yılı henüz başlamadı.</p>`; return; }
            const oneDay = 24 * 60 * 60 * 1000;
            const weekNumber = Math.ceil(((today - schoolStartDate) / oneDay + schoolStartDate.getDay() -1) / 7);
            const weekData = data.find(w => w.week === weekNumber);
            if (weekData) {
                container.innerHTML = `
                    <h4 class="font-bold text-lg mb-2 text-yellow-300">Hafta ${weekNumber}: ${weekData.dateRange}</h4>
                    <p><strong>Tema/Ünite:</strong> ${weekData.theme || 'Belirtilmemiş'}</p>
                    <p><strong>Konu:</strong> ${weekData.topic || 'Belirtilmemiş'}</p>
                    <p><strong>Kazanımlar:</strong> ${weekData.outcomes || 'Belirtilmemiş'}</p>
                    <p class="mt-2"><strong>Süreç/Açıklamalar:</strong> ${weekData.process || 'Belirtilmemiş'}</p>
                `;
            } else { container.innerHTML = `<p class="text-center text-gray-400">${grade}. sınıf için bu haftaya (${weekNumber}. Hafta) ait kazanım bilgisi bulunamadı.</p>`; }
        };

        const updateTimeAndLessons = () => {
            const now = new Date();
            const dayName = days[now.getDay() - 1];
            const currentTime = now.toTimeString().slice(0, 5);
            document.getElementById('current-time').textContent = `${now.toLocaleDateString('tr-TR')} ${currentTime}`;
            document.querySelectorAll('.current-lesson').forEach(el => el.classList.remove('current-lesson'));
            ['current-lesson-info', 'next-lesson-info'].forEach(id => document.getElementById(id).textContent = 'Ders Yok');
            document.getElementById('current-lesson-note-preview').textContent = '';

            for (let i = 0; i < hours.length; i++) {
                const [start, end] = hours[i].split(' - ');
                const lesson = scheduleData[`${dayName}-${i}`];
                if (currentTime >= start && currentTime <= end) {
                    const cell = document.querySelector(`td[data-day="${dayName}"][data-hour-index="${i}"]`);
                    if(cell) cell.classList.add('current-lesson');
                    if(lesson && lesson.name) {
                        document.getElementById('current-lesson-info').textContent = lesson.name;
                        const todayStr = now.toISOString().split('T')[0];
                        if (lesson.notes && lesson.notes[todayStr]) {
                            document.getElementById('current-lesson-note-preview').textContent = `📝 Not: ${lesson.notes[todayStr]}`;
                        }
                    }
                }
                if (currentTime < start && document.getElementById('next-lesson-info').textContent === 'Ders Yok') {
                     if (lesson && lesson.name) {
                        document.getElementById('next-lesson-info').textContent = `${start} - ${lesson.name}`;
                    }
                }
            }
            checkReminders(now);
        };
        
        // --- LESSON MODAL ---
        const modal = document.getElementById('lesson-modal');
        const openModal = (day, hourIndex) => {
            currentCell = { day, hourIndex };
            const key = `${day}-${hourIndex}`;
            const lesson = scheduleData[key] || { name: '', notes: {} };
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-title').textContent = `${day} - ${hours[hourIndex]}`;
            document.getElementById('lesson-name').value = lesson.name || '';
            document.getElementById('note-date').value = today;
            document.getElementById('lesson-note').value = (lesson.notes && lesson.notes[today]) || '';
            modal.classList.remove('hidden');
        };
        const closeModal = () => modal.classList.add('hidden');
        document.getElementById('cancel-button').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        document.getElementById('save-button').addEventListener('click', () => {
            const { day, hourIndex } = currentCell;
            const key = `${day}-${hourIndex}`;
            if (!scheduleData[key]) scheduleData[key] = { name: '', notes: {} };
            scheduleData[key].name = document.getElementById('lesson-name').value.trim();
            const noteDate = document.getElementById('note-date').value;
            const noteText = document.getElementById('lesson-note').value.trim();
            if (noteText) {
                 if(!scheduleData[key].notes) scheduleData[key].notes = {};
                 scheduleData[key].notes[noteDate] = noteText;
            } else {
                if(scheduleData[key].notes) delete scheduleData[key].notes[noteDate];
            }
            saveDataToFirestore();
            closeModal();
        });
        
        document.getElementById('today-button').addEventListener('click', () => {
            const dateInput = document.getElementById('note-date');
            dateInput.value = new Date().toISOString().split('T')[0];
            dateInput.dispatchEvent(new Event('change'));
        });

        document.getElementById('note-date').addEventListener('change', (e) => {
            const { day, hourIndex } = currentCell;
            const key = `${day}-${hourIndex}`;
            const lesson = scheduleData[key] || { notes: {} };
            document.getElementById('lesson-note').value = (lesson.notes && lesson.notes[e.target.value]) || '';
        });

        // --- DELETION & CONFIRMATION ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-button');
        const confirmationMessage = document.getElementById('confirmation-message');
        
        let onConfirm = () => {};
        
        const showConfirmation = (message, confirmCallback) => {
            confirmationMessage.textContent = message;
            onConfirm = confirmCallback;
            confirmationModal.classList.remove('hidden');
        };

        document.getElementById('delete-lesson-button').addEventListener('click', () => {
             showConfirmation('Bu dersi kalıcı olarak silmek istediğinizden emin misiniz?', () => {
                const { day, hourIndex } = currentCell;
                const key = `${day}-${hourIndex}`;
                delete scheduleData[key];
                saveDataToFirestore();
                closeModal();
             });
        });

        confirmDeleteBtn.addEventListener('click', () => {
            onConfirm();
            confirmationModal.classList.add('hidden');
        });
        document.getElementById('confirm-cancel-button').addEventListener('click', () => confirmationModal.classList.add('hidden'));

        // --- CLASS NOTES MODAL ---
        const classNotesModal = document.getElementById('class-notes-modal');
        const notesGrid = document.getElementById('notes-grid');
        let currentGrade = null;
        let editingNoteId = null;

        window.openNotesModal = (grade) => {
            currentGrade = grade;
            editingNoteId = null;
            document.getElementById('class-notes-title').textContent = `${grade}. Sınıf Notları`;
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            document.getElementById('add-note-button').textContent = 'Not Ekle';
            renderClassNotes(grade);
            classNotesModal.classList.remove('hidden');
        };

        const closeNotesModal = () => classNotesModal.classList.add('hidden');
        document.getElementById('close-class-notes-button').addEventListener('click', closeNotesModal);

        const renderClassNotes = (grade) => {
            notesGrid.innerHTML = '';
            const notes = classNotes[grade] || [];
            notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-card';
                noteEl.innerHTML = `
                    <button class="delete-note-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <div class="note-content-wrapper">
                        <h4 class="font-bold text-lg mb-2 truncate">${note.title}</h4>
                        <p class="text-gray-300 whitespace-pre-wrap">${note.content}</p>
                    </div>
                `;
                noteEl.querySelector('.note-content-wrapper').addEventListener('click', () => {
                    editingNoteId = note.id;
                    document.getElementById('new-note-title').value = note.title;
                    document.getElementById('new-note-content').value = note.content;
                    document.getElementById('add-note-button').textContent = 'Değişiklikleri Kaydet';
                });
                noteEl.querySelector('.delete-note-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmation('Bu notu kalıcı olarak silmek istediğinizden emin misiniz?', () => {
                        const noteIndex = classNotes[currentGrade].findIndex(n => n.id === note.id);
                        if(noteIndex > -1) {
                            classNotes[currentGrade].splice(noteIndex, 1);
                            saveDataToFirestore();
                        }
                    });
                });
                notesGrid.appendChild(noteEl);
            });
        };
        
        document.getElementById('add-note-button').addEventListener('click', () => {
            const title = document.getElementById('new-note-title').value.trim();
            const content = document.getElementById('new-note-content').value.trim();
            if(!title && !content) return;
            
            if (!classNotes[currentGrade]) classNotes[currentGrade] = [];
            
            if (editingNoteId) { // Update existing note
                const note = classNotes[currentGrade].find(n => n.id === editingNoteId);
                if (note) {
                    note.title = title;
                    note.content = content;
                }
            } else { // Add new note
                const newNote = { id: Date.now().toString(), title, content };
                classNotes[currentGrade].push(newNote);
            }
            
            saveDataToFirestore();
            editingNoteId = null;
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            document.getElementById('add-note-button').textContent = 'Not Ekle';
        });

        // --- GENERAL ---
        document.getElementById('save-settings-button').addEventListener('click', () => {
            saveDataToFirestore();
            createNotification('Ayarlar başarıyla kaydedildi!', 'success');
        });
        const updateHeaderInfo = () => {
            document.getElementById('user-name').textContent = document.getElementById('name-input').value || 'İsim Soyisim';
            document.getElementById('user-branch').textContent = document.getElementById('branch-input').value || 'Branş';
        };
        window.changeTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('active');
            const futureNotesContainer = document.getElementById('future-notes-container');
            if (tabName === 'schedule' || tabName === 'class-notes') futureNotesContainer.classList.remove('hidden');
            else futureNotesContainer.classList.add('hidden');
        };
        const createNotification = (message, type = 'info', duration = 5000) => {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', reminder: 'bg-yellow-500 text-black' };
            notif.className = `notification ${colors[type]} text-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-2`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.classList.remove('opacity-0', 'translate-y-2'), 100);
            setTimeout(() => { notif.classList.add('opacity-0'); notif.addEventListener('transitionend', () => notif.remove()); }, duration);
            notif.addEventListener('click', () => { notif.classList.add('opacity-0'); notif.addEventListener('transitionend', () => notif.remove()); });
        };
        const checkReminders = (now) => {
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            publicHolidays.forEach(holiday => {
                const holidayDate = new Date(holiday.date);
                if (Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24)) === 1) {
                    const reminderKey = `reminder-holiday-${holiday.date}`;
                    if (!sessionStorage.getItem(reminderKey)) {
                        createNotification(`Yarın: ${holiday.event}`, 'reminder', 10000);
                        sessionStorage.setItem(reminderKey, 'true');
                    }
                }
            });
        };
        const fileImporter = document.getElementById('file-importer');
        let importType = '';
        const importButtons = {
            'schedule': 'import-schedule-button', 'calendar': 'import-calendar-button',
            'acquisitions9': 'import-acquisitions-9-button', 'acquisitions10': 'import-acquisitions-10-button',
            'acquisitions11': 'import-acquisitions-11-button', 'acquisitions12': 'import-acquisitions-12-button'
        };
        for(const type in importButtons) document.getElementById(importButtons[type]).addEventListener('click', () => { importType = type; fileImporter.click(); });
        fileImporter.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = JSON.parse(e.target.result);
                    if (importType === 'schedule') scheduleData = content;
                    else if (importType === 'calendar') academicCalendar = content;
                    else if (importType === 'acquisitions9') acquisitions9Data = content;
                    else if (importType === 'acquisitions10') acquisitions10Data = content;
                    else if (importType === 'acquisitions11') acquisitions11Data = content;
                    else if (importType === 'acquisitions12') acquisitions12Data = content;
                    saveDataToFirestore(); createNotification('Veri başarıyla içe aktarıldı.', 'success');
                } catch (error) { createNotification('Geçersiz dosya formatı.', 'error'); }
            };
            reader.readAsText(file); event.target.value = null;
        });
        const formatDate = (dateString, options = {}) => {
            const date = new Date(dateString.replace(/-/g, '/'));
            const defaultOptions = { day: '2-digit', month: 'long', year: 'numeric', weekday: 'long' };
            return date.toLocaleDateString('tr-TR', { ...defaultOptions, ...options });
        };
        const initialAcquisitions9 = [ {"week":1,"dateRange":"08-12 Eylül","theme":"SÖZÜN İNCELİĞİ","outcomes":"Okumayı yönetebilme","process":"Okuma amacını belirler, metnin türüne yönelik tahminlerde bulunur."}, {"week":2,"dateRange":"15-19 Eylül","theme":"SÖZÜN İNCELİĞİ","outcomes":"Anlam oluşturabilme","process":"Edebiyatın güzel sanatlarla ilişkisini belirler, metindeki açık ve örtük iletiyi bulur."}, {"week":3,"dateRange":"22-26 Eylül","theme":"SÖZÜN İNCELİĞİ","outcomes":"Anlam oluşturabilme (devam)","process":"Metnin temasını, söz sanatlarını ve yazarla ilişkisini belirler."}, {"week":4,"dateRange":"29 Eylül-03 Ekim","theme":"SÖZÜN İNCELİĞİ","outcomes":"Yazma sürecini yönetebilme","process":"Yazma amacına karar verir, hedef kitleye göre metin türünü belirler."} ];
        const initialAcquisitions12 = [ {"week":1,"dateRange":"08-12 Eylül","theme":"GİRİŞ","topic":"Edebiyat ve Düşünce Akımları","outcomes":"Edebî eserlerin felsefi bir anlayışı yansıtabileceği üzerinde durulur.","process":"15 Temmuz Demokrasi ve Milli Birlik Günü anılır. Metinden hareketle dil bilgisi çalışmaları yapılır."}, {"week":2,"dateRange":"15-19 Eylül","theme":"GİRİŞ","topic":"Yazma ve Sunum","outcomes":"Toplumsal değişimin dili nasıl etkilediği hakkında yazı yazar.","process":"Teknolojik terimler üzerine sunum yapılır."}, {"week":3,"dateRange":"22-26 Eylül","theme":"HİKÂYE","topic":"1960 Sonrası Hikâye","outcomes":"Metnin türünün tarihsel dönem ile ilişkisini, tema ve konusunu belirler.","process":"Metindeki çatışmalar ve olay örgüsü belirlenir."}, {"week":4,"dateRange":"29 Eylül - 03 Ekim","theme":"HİKÂYE","topic":"1960 Sonrası Hikâye","outcomes":"Metindeki şahıs kadrosu, zaman ve mekânın özelliklerini belirler.","process":"Anlatıcı ve bakış açısının işlevi incelenir."} ];

        startApp();
    </script>
</body>
</html>

